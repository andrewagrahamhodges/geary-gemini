# Geary-Gemini Build System
#
# Usage:
#   docker compose build --no-cache && docker compose up
#   OR just: docker compose up --build (uses layer cache for deps, rebuilds source)
#
# Output:
#   ./dist/geary-gemini_*.deb
#
# Tests must pass or it fails.

services:
  build:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/src:ro
      - ./dist:/output
    working_dir: /src
    command:
      - bash
      - -ex
      - -c
      - |
        BUILD_DIR=/tmp/build
        STAGING=/tmp/staging
        rm -rf $$BUILD_DIR $$STAGING /output/*.deb
        mkdir -p $$BUILD_DIR

        echo "=========================================="
        echo "CONFIGURE"
        echo "=========================================="
        meson setup $$BUILD_DIR --prefix=/usr --buildtype=release -Dprofile=release

        echo "=========================================="
        echo "BUILD"
        echo "=========================================="
        ninja -C $$BUILD_DIR

        echo "=========================================="
        echo "TEST (non-GUI)"
        echo "=========================================="
        meson test -C $$BUILD_DIR --no-rebuild --print-errorlogs \
          --suite geary:engine-tests \
          --suite geary:mail-merge-test \
          --suite vala-unit:tests

        echo "=========================================="
        echo "PACKAGE"
        echo "=========================================="
        DESTDIR=$$STAGING meson install -C $$BUILD_DIR

        echo "Bundling Node.js and gemini-cli..."
        NODE_VERSION="v22.12.0"
        GEMINI_DIR="$$STAGING/usr/share/geary-gemini"
        mkdir -p "$$GEMINI_DIR/node"
        curl -fsSL "https://nodejs.org/dist/$${NODE_VERSION}/node-$${NODE_VERSION}-linux-x64.tar.xz" \
          | tar -xJ -C "$$GEMINI_DIR/node" --strip-components=1
        export PATH="$$GEMINI_DIR/node/bin:$$PATH"
        npm install --prefix "$$GEMINI_DIR" @google/gemini-cli
        rm -rf "$$GEMINI_DIR/node/share" "$$GEMINI_DIR/node/include"


        VERSION=$$(grep -m1 "version:" /src/meson.build | cut -d"'" -f2)
        mkdir -p $$STAGING/DEBIAN
        cat > $$STAGING/DEBIAN/control << EOF
        Package: geary-gemini
        Version: $${VERSION}
        Section: mail
        Priority: optional
        Architecture: amd64
        Depends: libgtk-3-0t64, libwebkit2gtk-4.1-0, libgee-0.8-2, libgmime-3.0-0t64, libsqlite3-0, libsecret-1-0, libhandy-1-0, libfolks26, libgoa-1.0-0b, libgspell-1-3, libgsound0t64, libpeas-2-0, libenchant-2-2, libytnef0
        Maintainer: Andrew Hodges <andrew@hodges.id.au>
        Description: Geary email client with Gemini AI integration
         Geary is a modern email client for GNOME, enhanced with
         Gemini AI capabilities for translation, summarization,
         and natural language email management.
        EOF
        sed -i 's/^        //' $$STAGING/DEBIAN/control

        dpkg-deb --build $$STAGING /output/geary-gemini_$${VERSION}_amd64.deb
        chmod 644 /output/geary-gemini_$${VERSION}_amd64.deb

        echo "=========================================="
        echo "DONE"
        echo "=========================================="
        ls -lh /output/*.deb
